<?xml version="1.0" encoding="UTF-8"?>
<AST xmlns:node="http://nikic.github.com/PHPParser/XML/node" xmlns:subNode="http://nikic.github.com/PHPParser/XML/subNode" xmlns:attribute="http://nikic.github.com/PHPParser/XML/attribute" xmlns:scalar="http://nikic.github.com/PHPParser/XML/scalar">
 <scalar:array>
  <node:Stmt_InlineHTML>
   <attribute:startLine>
    <scalar:int>1</scalar:int>
   </attribute:startLine>
   <attribute:endLine>
    <scalar:int>143</scalar:int>
   </attribute:endLine>
   <subNode:value>
    <scalar:string>&lt;?
	include_once(dirname(__FILE__) . DIRECTORY_SEPARATOR . &quot;inc&quot; . DIRECTORY_SEPARATOR . &quot;config.php&quot;);		
	if (!defined('_PS_ADMIN_DIR_'))
		define('_PS_ADMIN_DIR_', getcwd());
	require_once('../../config/config.inc.php');
	require_once('../init.php');
	$error = '';
	$fileMoved = array();
	$unmovedDocDueToSamePath = array();
	if(CONFIG_SYS_VIEW_ONLY || (!CONFIG_OPTIONS_CUT &amp;&amp; !CONFIG_OPTIONS_COPY))
	{
		$error = SYS_DISABLED;
	}
	elseif(empty($_GET['current_folder_path']))
		{
			$error = ERR_NOT_DEST_FOLDER_SPECIFIED;
		}elseif(!file_exists($_GET['current_folder_path']) || !is_dir($_GET['current_folder_path']))
		{
			$error = ERR_DEST_FOLDER_NOT_FOUND;
		}elseif(!isUnderRoot($_GET['current_folder_path']))
		{
			$error = ERR_DEST_FOLDER_NOT_ALLOWED;
		}else 
		{
			
			include_once(CLASS_MANAGER);
			include_once(CLASS_SESSION_ACTION);
			$sessionAction = new SessionAction();
			include_once(DIR_AJAX_INC . &quot;class.manager.php&quot;);	
			$manager = new manager();
			$manager-&gt;setSessionAction($sessionAction);
			$selectedDocuments = $sessionAction-&gt;get();
			
			$destFolderPath = addTrailingSlash(backslashToSlash($_GET['current_folder_path']));
			
			
			if(sizeof($selectedDocuments))
			{
				//get all files within the destination folder
				$allDocs = array();
				if(($fh = @opendir($_GET['current_folder_path'])))
				{
					while(($file = readdir($fh)) &amp;&amp; $file != '.' &amp;&amp; $file != '..')
					{
						$allDocs[] = getRealPath($destFolderPath . $file);
					}
				}
				closedir($fh);
				include_once(CLASS_FILE);
				$file = new file();
				//check if all files are allowed to cut or copy

				foreach($selectedDocuments as $doc)
				{
					if(file_exists($doc) &amp;&amp; isUnderRoot($doc) )
					{
						
						if( array_search(getRealPath($doc), $allDocs) === false || CONFIG_OVERWRITTEN)
						{
							if(CONFIG_OVERWRITTEN)
							{
								$file-&gt;delete($doc);
							}
							if($file-&gt;copyTo($doc, $_GET['current_folder_path']))
							{
								
								$finalPath = $destFolderPath . basename($doc);
								$objFile = new file($finalPath);
								$tem = $objFile-&gt;getFileInfo();
								$obj = new manager($finalPath, false);			
													
								$fileType = $obj-&gt;getFileType($finalPath, (is_dir($finalPath)?true:false));
								
								foreach($fileType as $k=&gt;$v)
								{
									$tem[$k] = $v;
								}
								
/*								foreach ($folderInfo as $k=&gt;$v)
								{
									$tem['i_' . $k] = $v;
								}
								if($folderInfo['type'] == 'folder' &amp;&amp; empty($folderInfo['subdir']) &amp;&amp;  empty($folderInfo['file']))
								{
									$tem['cssClass'] = 'folderEmpty';
								}*/
								
								$tem['final_path'] = $finalPath;
								$tem['path'] = backslashToSlash($finalPath);		
								$tem['type'] = (is_dir($finalPath)?'folder':'file');
								$tem['size'] = @transformFileSize($tem['size']);
								$tem['ctime'] = date(DATE_TIME_FORMAT, $tem['ctime']);
								$tem['mtime'] = date(DATE_TIME_FORMAT, $tem['mtime']);
								$tem['flag'] = 'noFlag';
								$tem['url'] = getFileUrl($doc);
		
								$manager = null;
								if($sessionAction-&gt;getAction() == &quot;cut&quot;)
								{
									$file-&gt;delete($doc);
								}
								$fileMoved[sizeof($fileMoved)] = $tem;
								$tem = null;
							}							
						}else 
						{
							$unmovedDocDueToSamePath[] = $doc;
						}
							
					}
				}

				$sessionAction-&gt;set(array());
			}
			if(sizeof($unmovedDocDueToSamePath) == sizeof($selectedDocuments))
			{
				$error = ERR_DEST_FOLDER_NOT_ALLOWED;
			}elseif(sizeof($unmovedDocDueToSamePath)) 
			{
				foreach($unmovedDocDueToSamePath as $v)
				{
					$error .=  sprintf(ERR_UNABLE_TO_MOVE_TO_SAME_DEST, $v) . &quot;\r\n&quot;;
				}
			}
		}
		
		echo &quot;{'error':'&quot; . $error . &quot;', 'unmoved_files':&quot; . sizeof($unmovedDocDueToSamePath) . &quot;, 'files':{&quot;;
		foreach($fileMoved as  $i=&gt;$file)
		{
			
			echo ($i&gt;0?', ':' ') . $i . &quot;: { &quot;;
			$j = 0;
			foreach($file as $k=&gt;$v)
			{
				echo ($j++ &gt; 0? &quot;, &quot;:'') . &quot;'&quot; . $k . &quot;':'&quot; . $v . &quot;'&quot;; 
				
			}
			echo &quot;} &quot;;
		}
		echo &quot;} }&quot;;
	
?&gt;
</scalar:string>
   </subNode:value>
  </node:Stmt_InlineHTML>
 </scalar:array>
</AST>
